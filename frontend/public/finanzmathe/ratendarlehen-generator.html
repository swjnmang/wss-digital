<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ratendarlehen Tilgungsplan Aufgabe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Optional: Custom styles if needed */
        .table-input {
            width: 100px; /* Adjust width as needed */
            padding: 4px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: right;
            display: inline-block; /* Allow space for icon */
            margin-right: 5px; /* Space between input and icon */
        }
        .input-container {
            display: flex;
            align-items: center;
        }
        .feedback-icon {
            font-size: 1.2em;
        }
        .correct-icon {
            color: #10b981; /* Tailwind green-500 */
        }
        .incorrect-icon {
            color: #ef4444; /* Tailwind red-500 */
        }
        .empty-cell {
            background-color: #f3f4f6; /* Light gray background for empty cell */
        }
        .separator-row td {
            border-top: 2px solid #d1d5db; /* Add a top border for separation */
            padding-top: 10px; /* Add some space above the line */
        }
         .separator-row {
            line-height: 0.1em;
         }
         .separator-row span {
            background:#fff;
            padding:0 10px;
         }
    </style>
</head>
<body class="bg-gray-100 p-6">
    <div class="container mx-auto bg-white p-8 rounded-lg shadow-md">
        <a href="index.html" class="text-blue-600 hover:underline mb-4 inline-block">
            &larr; Zurück zur Übersicht
        </a>
        <h1 class="text-2xl font-bold mb-6 text-center">Aufgabe: Tilgungsplan Ratendarlehen</h1>

        <div id="task-description" class="mb-6">
            <p id="task-intro"></p>
            <p id="loan-details-text"></p>
            <p id="fill-instructions-text"></p>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-300 rounded-lg">
                <thead>
                    <tr>
                        <th class="py-2 px-4 border-b text-left">Jahr (v)</th>
                        <th class="py-2 px-4 border-b text-left">Schulden zu Jahresbeginn in €</th>
                        <th class="py-2 px-4 border-b text-left">Zinsen in €</th>
                        <th class="py-2 px-4 border-b text-left">Tilgung in €</th>
                        <th class="py-2 px-4 border-b text-left">Annuität in €</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td class="py-2 px-4 border-b">1</td>
                        <td class="py-2 px-4 border-b">
                             <div class="input-container">
                                <input type="number" step="0.01" id="input-k0" class="table-input" placeholder="K₀">
                                <span id="feedback-k0" class="feedback-icon"></span>
                            </div>
                        </td>
                        <td class="py-2 px-4 border-b">
                             <div class="input-container">
                                <input type="number" step="0.01" id="input-z1" class="table-input" placeholder="Z₁">
                                <span id="feedback-z1" class="feedback-icon"></span>
                            </div>
                        </td>
                        <td class="py-2 px-4 border-b">
                            <div class="input-container">
                                <input type="number" step="0.01" id="input-t1" class="table-input" placeholder="T">
                                <span id="feedback-t1" class="feedback-icon"></span>
                            </div>
                        </td>
                        <td class="py-2 px-4 border-b">
                            <div class="input-container">
                                <input type="number" step="0.01" id="input-a1" class="table-input" placeholder="A₁">
                                <span id="feedback-a1" class="feedback-icon"></span>
                            </div>
                        </td>
                    </tr>
                    <tr>
                        <td class="py-2 px-4 border-b">2</td>
                         <td class="py-2 px-4 border-b">
                            <div class="input-container">
                                <input type="number" step="0.01" id="input-k1" class="table-input" placeholder="K₁">
                                <span id="feedback-k1" class="feedback-icon"></span>
                            </div>
                        </td>
                        <td class="py-2 px-4 border-b">
                            <div class="input-container">
                                <input type="number" step="0.01" id="input-z2" class="table-input" placeholder="Z₂">
                                <span id="feedback-z2" class="feedback-icon"></span>
                            </div>
                        </td>
                        <td class="py-2 px-4 border-b">
                            <div class="input-container">
                                <input type="number" step="0.01" id="input-t2" class="table-input" placeholder="T">
                                <span id="feedback-t2" class="feedback-icon"></span>
                            </div>
                        </td>
                        <td class="py-2 px-4 border-b">
                            <div class="input-container">
                                <input type="number" step="0.01" id="input-a2" class="table-input" placeholder="A₂">
                                <span id="feedback-a2" class="feedback-icon"></span>
                            </div>
                        </td>
                    </tr>
                    <tr id="separator-row" class="separator-row">
                        <td colspan="5" class="py-2 px-4 border-b"></td>
                    </tr>
                    <tr id="intermediate-row">
                        <td class="py-2 px-4 border-b" id="intermediate-year-display"></td>
                         <td class="py-2 px-4 border-b">
                            <div class="input-container">
                                <input type="number" step="0.01" id="input-kv-1" class="table-input" placeholder="Kᵥ₋₁">
                                <span id="feedback-kv-1" class="feedback-icon"></span>
                            </div>
                        </td>
                        <td class="py-2 px-4 border-b">
                            <div class="input-container">
                                <input type="number" step="0.01" id="input-zv" class="table-input" placeholder="Zᵥ">
                                <span id="feedback-zv" class="feedback-icon"></span>
                            </div>
                        </td>
                        <td class="py-2 px-4 border-b">
                            <div class="input-container">
                                <input type="number" step="0.01" id="input-tv" class="table-input" placeholder="T">
                                <span id="feedback-tv" class="feedback-icon"></span>
                            </div>
                        </td>
                        <td class="py-2 px-4 border-b">
                            <div class="input-container">
                                <input type="number" step="0.01" id="input-av" class="table-input" placeholder="Aᵥ">
                                <span id="feedback-av" class="feedback-icon"></span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="mt-6 flex justify-center space-x-4">
            <button id="generate-task" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                Neue Aufgabe generieren
            </button>
            <button id="check-answers" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                Antworten prüfen
            </button>
             <button id="show-tip" class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded">
                Tipp anzeigen
            </button>
        </div>

        <div id="feedback" class="mt-6 text-center font-bold"></div>
        <div id="tip-area" class="mt-4 p-4 bg-blue-100 border border-blue-400 text-blue-700 rounded hidden">
            <strong>Tipp:</strong> <span id="tip-text"></span>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const taskIntroParagraph = document.getElementById('task-intro');
            const loanDetailsText = document.getElementById('loan-details-text');
            const fillInstructionsText = document.getElementById('fill-instructions-text'); // Get the new paragraph

            const inputK0 = document.getElementById('input-k0');
            const inputZ1 = document.getElementById('input-z1');
            const inputT1 = document.getElementById('input-t1');
            const inputA1 = document.getElementById('input-a1');
            const inputK1 = document.getElementById('input-k1');
            const inputZ2 = document.getElementById('input-z2');
            const inputT2 = document.getElementById('input-t2');
            const inputA2 = document.getElementById('input-a2');
            const inputKv1 = document.getElementById('input-kv-1');
            const inputZv = document.getElementById('input-zv');
            const inputTv = document.getElementById('input-tv');
            const inputAv = document.getElementById('input-av');

            const intermediateYearDisplay = document.getElementById('intermediate-year-display');
            const intermediateRow = document.getElementById('intermediate-row');
            const separatorRow = document.getElementById('separator-row');


            const generateButton = document.getElementById('generate-task');
            const checkButton = document.getElementById('check-answers');
            const showTipButton = document.getElementById('show-tip');
            const feedbackDiv = document.getElementById('feedback');
            const tipArea = document.getElementById('tip-area');
            const tipTextSpan = document.getElementById('tip-text');

            let correctValues = {};
            let randomYear = 0; // To store the randomly generated intermediate year
            let currentK0 = 0; // To store the generated K0
            let currentRate = 0; // Store the exact rate used for calculations
            let currentN = 0; // Store loan term
            let calculatedTilgung = 0; // Store the calculated constant Tilgung

            let activeInputId = null;

            // Alternative task introduction texts
            const introTexts = [
                "Ein Unternehmen nimmt ein Ratendarlehen auf, um eine neue Maschine zu finanzieren.",
                "Zur Anschaffung neuer Betriebsmittel nimmt ein Betrieb ein Ratendarlehen auf.",
                "Ein Kreditinstitut vergibt ein Ratendarlehen an einen Kunden.",
                "Ein Darlehen wird als Ratendarlehen mit fester Tilgung vereinbart."
            ];

            // Alternative loan detail templates
            const loanDetailTemplates = [
                "Das Darlehen hat eine anfängliche Schuldenhöhe (K₀) von <strong>{k0}</strong>, eine Gesamtlaufzeit (n) von <strong>{n} Jahren</strong> und einen jährlichen Zinssatz von <strong>{rate} % p.a.</strong>",
                "Vereinbart wurde ein Ratendarlehen über <strong>{k0}</strong> mit einer Laufzeit von <strong>{n} Jahren</strong> und einem Zinssatz von <strong>{rate} % p.a.</strong>",
                "Die Konditionen des Ratendarlehens lauten: K₀ = <strong>{k0}</strong>, n = <strong>{n} Jahre</strong>, Zinssatz = <strong>{rate} % p.a.</strong>",
                "Ein Ratendarlehen wird mit folgenden Eckdaten aufgenommen: Anfängliche Schulden <strong>{k0}</strong>, Laufzeit <strong>{n} Jahre</strong>, Zinssatz <strong>{rate} % p.a.</strong>"
            ];

            // Add focus event listeners to all input fields
            const allInputs = [inputK0, inputZ1, inputT1, inputA1, inputK1, inputZ2, inputT2, inputA2, inputKv1, inputZv, inputTv, inputAv];
            allInputs.forEach(input => {
                input.addEventListener('focus', () => {
                    activeInputId = input.id;
                    tipArea.classList.add('hidden');
                    tipTextSpan.textContent = '';
                });
                 input.addEventListener('blur', () => {
                    setTimeout(() => {
                         if (document.activeElement !== showTipButton) {
                             activeInputId = null;
                         }
                    }, 10);
                 });
            });


            function generateTask() {
                // Generate random values
                const k0 = Math.floor(Math.random() * 100000) + 50000; // K0 between 50000 and 150000
                const n = Math.floor(Math.random() * 22) + 9; // n between 9 and 30
                const annualRateRaw = (Math.random() * 0.09) + 0.01; // Rate between 1% and 10%

                // Round the rate to one decimal place for display and calculation
                const ratePercentRounded = (annualRateRaw * 100).toFixed(1);
                const exactRate = parseFloat(ratePercentRounded) / 100; // Use this exact rate for calculations

                currentK0 = k0; // Store the generated K0
                currentRate = exactRate; // Store the exact rate used for calculations
                currentN = n; // Store the generated loan term

                // Calculate constant Tilgung T using the exactRate (Ratendarlehen)
                const T = k0 / n;
                calculatedTilgung = T; // Store the calculated Tilgung

                // Generate a random intermediate year (between 4 and n-1)
                randomYear = Math.floor(Math.random() * (n - 4)) + 4; // Year between 4 and n-1

                // Display the random intermediate year and show the row/separator
                intermediateYearDisplay.textContent = randomYear;
                intermediateRow.style.display = '';
                separatorRow.style.display = '';

                // Select random task texts
                const randomIntro = introTexts[Math.floor(Math.random() * introTexts.length)];
                const randomLoanDetailsTemplate = loanDetailTemplates[Math.floor(Math.random() * loanDetailTemplates.length)];

                // Format K0 in German commercial style with € after the value
                const formattedK0 = k0.toLocaleString('de-DE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' €';

                // Update task texts with generated values
                taskIntroParagraph.textContent = randomIntro;
                loanDetailsText.innerHTML = randomLoanDetailsTemplate
                    .replace('{k0}', formattedK0)
                    .replace('{n}', n)
                    .replace('{rate}', ratePercentRounded); // Display the rounded rate

                // Update fill instructions text
                fillInstructionsText.innerHTML = `Füllen Sie zunächst die fehlenden Felder der ersten beiden Jahre aus.<br> Füllen Sie nun die fehlenden Felder für das ${randomYear}. Jahr aus. Tipp: Es gibt hierfür passende Formeln in der Merkhilfe!`;


                // Calculate correct values for Ratendarlehen using the exactRate
                let currentDebt = k0;
                let Z1, A1, K1, Z2, A2, K2, Kv_1_intermediate, Zv_intermediate, Av_intermediate;

                // Year 1
                Z1 = currentDebt * exactRate;
                A1 = T + Z1;
                K1 = currentDebt - T;
                currentDebt = K1;

                // Year 2
                Z2 = currentDebt * exactRate;
                A2 = T + Z2;
                K2 = currentDebt - T;
                currentDebt = K2;

                // Intermediate Year (v)
                currentDebt = k0; // Reset for iterative calculation to year v-1
                for (let i = 1; i < randomYear; i++) {
                    currentDebt -= T;
                }
                Kv_1_intermediate = currentDebt;
                Zv_intermediate = Kv_1_intermediate * exactRate;
                Av_intermediate = T + Zv_intermediate;


                correctValues = {
                    k0: k0, // Store K0 as number for precise calculations in tips
                    z1: Z1,
                    t: T, // Tilgung is constant
                    a1: A1,
                    k1: K1,
                    z2: Z2,
                    a2: A2,
                    kv1_intermediate: Kv_1_intermediate,
                    zv_intermediate: Zv_intermediate,
                    tv_intermediate: T, // Tilgung is constant
                    av_intermediate: Av_intermediate
                };

                // Clear input fields, feedback icons, and feedback text
                allInputs.forEach(input => input.value = '');
                document.querySelectorAll('.feedback-icon').forEach(icon => icon.innerHTML = '');
                feedbackDiv.textContent = '';
                tipArea.classList.add('hidden');
                tipTextSpan.textContent = '';


                // Reset input field styles
                resetInputStyles();
            }

            function resetInputStyles() {
                const inputs = [inputK0, inputZ1, inputT1, inputA1, inputK1, inputZ2, inputT2, inputA2, inputKv1, inputZv, inputTv, inputAv];
                inputs.forEach(input => {
                    input.classList.remove('border-green-500', 'border-red-500');
                    input.classList.add('border-gray-300');
                });
            }

            function checkAnswers() {
                let allCorrect = true;
                const feedbackMessages = [];
                const tolerance = 0.02; // Allow a difference of up to 0.01 in either direction

                const inputs = [
                    { id: 'input-k0', correct: correctValues.k0, label: 'Schulden Jahresbeginn Jahr 1' },
                    { id: 'input-z1', correct: correctValues.z1, label: 'Zinsen Jahr 1' },
                    { id: 'input-t1', correct: correctValues.t, label: 'Tilgung Jahr 1' }, // Tilgung is constant
                    { id: 'input-a1', correct: correctValues.a1, label: 'Annuität Jahr 1' },
                    { id: 'input-k1', correct: correctValues.k1, label: 'Schulden Jahresbeginn Jahr 2' },
                    { id: 'input-z2', correct: correctValues.z2, label: 'Zinsen Jahr 2' },
                    { id: 'input-t2', correct: correctValues.t, label: 'Tilgung Jahr 2' }, // Tilgung is constant
                    { id: 'input-a2', correct: correctValues.a2, label: 'Annuität Jahr 2' }
                ];

                // Add intermediate year inputs to the list
                 inputs.push(
                    { id: 'input-kv-1', correct: correctValues.kv1_intermediate, label: `Schulden Jahresbeginn Jahr ${randomYear}` },
                    { id: 'input-zv', correct: correctValues.zv_intermediate, label: `Zinsen Jahr ${randomYear}` },
                    { id: 'input-tv', correct: correctValues.t, label: `Tilgung Jahr ${randomYear}` }, // Tilgung is constant
                    { id: 'input-av', correct: correctValues.av_intermediate, label: `Annuität Jahr ${randomYear}` }
                 );


                resetInputStyles(); // Reset styles before checking
                document.querySelectorAll('.feedback-icon').forEach(icon => icon.innerHTML = ''); // Clear previous icons

                inputs.forEach(item => {
                    const inputElement = document.getElementById(item.id);
                    const feedbackIconSpan = document.getElementById(`feedback-${item.id.split('-')[1]}${item.id.split('-')[2] ? '-' + item.id.split('-')[2] : ''}`);

                    const userAnswer = parseFloat(inputElement.value);
                    const correctAnswer = item.correct; // Use the number for comparison

                    // Check if input is a valid number
                    if (isNaN(userAnswer)) {
                        feedbackMessages.push(`${item.label}: Ungültige Eingabe`);
                        inputElement.classList.remove('border-gray-300', 'border-green-500');
                        inputElement.classList.add('border-red-500');
                        feedbackIconSpan.innerHTML = '<i class="fas fa-times-circle incorrect-icon"></i>';
                        allCorrect = false;
                    } else {
                        // Compare with tolerance
                        if (Math.abs(userAnswer - correctAnswer) < tolerance) {
                            feedbackMessages.push(`${item.label}: Korrekt`);
                            inputElement.classList.remove('border-gray-300', 'border-red-500');
                            inputElement.classList.add('border-green-500');
                            feedbackIconSpan.innerHTML = '<i class="fas fa-check-circle correct-icon"></i>';
                        } else {
                            // Indicate incorrect and show the correct value
                            feedbackMessages.push(`${item.label}: Falsch (Korrekter Wert: ${correctAnswer.toFixed(2)} €)`);
                            inputElement.classList.remove('border-gray-300', 'border-green-500');
                            inputElement.classList.add('border-red-500');
                            feedbackIconSpan.innerHTML = '<i class="fas fa-times-circle incorrect-icon"></i>';
                            allCorrect = false;
                        }
                    }
                });

                feedbackDiv.innerHTML = feedbackMessages.join('<br>');

                if (allCorrect) {
                    feedbackDiv.classList.remove('text-red-500');
                    feedbackDiv.classList.add('text-green-500');
                    feedbackDiv.innerHTML += '<br><br>Alle Antworten sind korrekt!';
                } else {
                    feedbackDiv.classList.remove('text-green-500');
                    feedbackDiv.classList.add('text-red-500');
                }
            }

            function showTip() {
                let tip = '';
                const rate = currentRate; // Use the exact rate for calculations
                const T = calculatedTilgung; // Use stored calculated Tilgung
                const n = currentN; // Use stored loan term

                // Get current values from inputs (even if incorrect) for context in tip
                const k0_input = parseFloat(inputK0.value);
                const z1_input = parseFloat(inputZ1.value);
                const t1_input = parseFloat(inputT1.value);
                const a1_input = parseFloat(inputA1.value);
                const k1_input = parseFloat(inputK1.value);
                const z2_input = parseFloat(inputZ2.value);
                const t2_input = parseFloat(inputT2.value);
                const a2_input = parseFloat(inputA2.value);
                const kv1_intermediate_input = parseFloat(inputKv1.value);
                const zv_intermediate_input = parseFloat(inputZv.value);
                const tv_intermediate_input = parseFloat(inputTv.value);
                const av_intermediate_input = parseFloat(inputAv.value);


                switch (activeInputId) {
                    case 'input-k0':
                        tip = `Die anfänglichen Schulden (K₀) sind im Aufgabentext angegeben.`;
                        break;
                    case 'input-z1':
                        tip = `Zinsen Jahr 1 (Z₁) = Schulden zu Jahresbeginn Jahr 1 (K₀) * Zinssatz. (K₀ = ${currentK0.toFixed(2)} €, Zinssatz = ${(currentRate * 100).toFixed(1)}%)`; // Use exactRate, formatted
                        break;
                    case 'input-t1':
                    case 'input-t2':
                    case 'input-tv':
                         tip = `Die Tilgung (T) ist bei einem Ratendarlehen über die gesamte Laufzeit konstant. T = Anfängliche Schulden (K₀) / Gesamtlaufzeit (n). (K₀ = ${currentK0.toFixed(2)} €, n = ${n})`;
                         break;
                    case 'input-a1':
                        tip = `Annuität Jahr 1 (A₁) = Tilgung (T) + Zinsen Jahr 1 (Z₁). (T = ${T.toFixed(2)} €, Z₁ = ${z1_input && !isNaN(z1_input) ? z1_input.toFixed(2) : '?'})`;
                        break;
                    case 'input-k1':
                        tip = `Schulden zu Jahresbeginn Jahr 2 (K₁) = Schulden zu Jahresbeginn Jahr 1 (K₀) - Tilgung (T). (K₀ = ${currentK0.toFixed(2)} €, T = ${T.toFixed(2)} €)`;
                        break;
                    case 'input-z2':
                         tip = `Zinsen Jahr 2 (Z₂) = Schulden zu Jahresbeginn Jahr 2 (K₁) * Zinssatz. (K₁ = ${k1_input && !isNaN(k1_input) ? k1_input.toFixed(2) : '?'}, Zinssatz = ${(currentRate * 100).toFixed(1)}%)`; // Use exactRate, formatted
                         break;
                    case 'input-a2':
                         tip = `Annuität Jahr 2 (A₂) = Tilgung (T) + Zinsen Jahr 2 (Z₂). (T = ${T.toFixed(2)} €, Z₂ = ${z2_input && !isNaN(z2_input) ? z2_input.toFixed(2) : '?'})`;
                         break;
                    case 'input-kv-1':
                         tip = `Schulden zu Jahresbeginn Jahr ${randomYear} (Kᵥ₋₁) = Schulden zu Jahresbeginn des Vorjahres - Tilgung (T). Wiederholen Sie diesen Schritt beginnend bei K₀. (T = ${T.toFixed(2)} €)`;
                         break;
                    case 'input-zv':
                         tip = `Zinsen Jahr ${randomYear} (Zᵥ) = Schulden zu Jahresbeginn Jahr ${randomYear} (Kᵥ₋₁) * Zinssatz. (Kᵥ₋₁ = ${kv1_intermediate_input && !isNaN(kv1_intermediate_input) ? kv1_intermediate_input.toFixed(2) : '?'}, Zinssatz = ${(currentRate * 100).toFixed(1)}%)`; // Use exactRate, formatted
                         break;
                    case 'input-av':
                         tip = `Annuität Jahr ${randomYear} (Aᵥ) = Tilgung (T) + Zinsen Jahr ${randomYear} (Zᵥ). (T = ${T.toFixed(2)} €, Zᵥ = ${zv_intermediate_input && !isNaN(zv_intermediate_input) ? zv_intermediate_input.toFixed(2) : '?'})`;
                         break;
                    default:
                        tip = 'Wählen Sie ein Feld in der Tabelle aus, um einen Tipp zu erhalten.';
                }

                tipTextSpan.textContent = tip;
                tipArea.classList.remove('hidden');
            }

            // Event Listeners
            generateButton.addEventListener('click', generateTask);
            checkButton.addEventListener('click', checkAnswers);
            showTipButton.addEventListener('click', showTip);


            // Generate initial task on page load
            generateTask();
        });
    </script>
</body>
</html>
